---
title: The science of MSBuild ⚗️
lead: How to express build dependencies using MSBuild Targets, Inputs and Outputs
layout: post
---

# The science of MSBuild ⚗️

> Add this to the list of things I did not expect to be writing...

## Dependency graph

I prefer [Tundra](https://github.com/deplinenoise/tundra) over MSBuild because it does not hide the fact that the build system is using a directed acyclic graph (DAG) to figure out when to build what.

With MSBuild each _target_ is a node with inputs and outputs. If you define a target you define a DAG node, if you want MSBuild to invalidate this target when dependant inputs change you have to list them in the `Inputs` attribute to the target. As a quirk, MSBuild will require that you specify `Outputs` as well (possibly to support incremental builds).

Targets without input and output information are wonky, MSBuild won't be able tell what is the correct order of the build without them.

## Code generation tool + code generation

Let's say we have two projects in a solution. Project A (`PA`) is a code generation tool and Project B (`PB`) depends on code generated by this tool.

The build should progress like this:

- `build PA`
- `run PA`
- `build PB`

The way we accomplish this with MSBuild is to specify the code generation tool as an input to our code generation target and the generated code as output.

~~~xml
<Project>
  <Target Name="CodeGeneration"
          BeforeTargets="Build"
          Inputs="$(SolutionDir)CodeGenerationTool\bin\$(ConfigurationName)\net461\CodeGenerationTool.exe"
          Outputs="$(ProjectDir)\code.generated.cs">
    <Exec Command="$(SolutionDir)CodeGenerationTool\bin\$(ConfigurationName)\net461\CodeGenerationTool.exe -output &quot;$(ProjectDir)\code.generated.cs&quot;" />
  </Target>
</Project>
~~~

This is a snippet from a `CodeGeneration.targets` file. We can put these in our project directory and import them into the project file (and skip having to unload/load project file from within Visual Studio).

~~~xml
<Project Sdk="Microsoft.NET.Sdk">
  <Import Project="CodeGeneration.targets" />
  <PropertyGroup>
    <TargetFramework>net461</TargetFramework>
  </PropertyGroup>
</Project>
~~~

With all of this configured MSBuild will rebuild the code generation tool, the generated code and the project that depends on the generated code as needed. Without having to trigger needless rebuilds (this is never the solution).
